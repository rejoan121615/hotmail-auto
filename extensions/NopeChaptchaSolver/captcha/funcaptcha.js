(()=>{var d=chrome;function k(e){let t=("fff12fa3cdd64ff83a30d7b392be57e978a86eee93b9728ed0366bf231abdaad"+e).split("").map(n=>n.charCodeAt(0));return w(t)}var v=new Uint32Array(256);for(let e=256;e--;){let t=e;for(let n=8;n--;)t=t&1?3988292384^t>>>1:t>>>1;v[e]=t}function w(e){let t=-1;for(let n of e)t=t>>>8^v[t&255^n];return(t^-1)>>>0}async function r(e,t){let n=""+[+new Date,performance.now(),Math.random()],[o,i]=await new Promise(a=>{d.runtime.sendMessage([n,e,...t],a)});if(o===k(n))return i}function C(){let e;return t=>e||(e=t().finally(()=>e=void 0),e)}var S=[];function f(e,t,n){let o=[e,t,n];S.push(o),M(o,p())}function M(e,t){let n=e[1](t),o=!!e[3];n!==o&&(n?e[3]=e[2]():(e[3](),e[3]=null))}function A(e){S.forEach(t=>M(t,e))}var O=C(),c;function x(){return O(async()=>(c||(c=await r("settings::get",[])),c))}function H(e){c&&(c={...c,...e},A(c))}function p(){return c}function B(){d.runtime.connect({name:"stream"}).onMessage.addListener(t=>{t.event==="settingsUpdate"&&H(t.settings)})}function h(e){if(document.readyState!=="loading")setTimeout(e,0);else{let t;t=()=>{removeEventListener("DOMContentLoaded",t),e()},addEventListener("DOMContentLoaded",t)}}function s(e){return new Promise(t=>setTimeout(t,e))}var N=["#home_children_button","#wrong_children_button","#wrongTimeout_children_button","button[data-theme*=verifyButton]","[class*=game-fail] .button",".error .button"],E=["#root","#app","#home","#wrong","#wrongTimeout",".container[dir]"].join(", ");async function L(){for(;!document.querySelector(E);)await s(100)}function D(){let e,t=()=>{N.map(n=>document.querySelector(n)).filter(n=>n).map(n=>n.click()),document.querySelectorAll(E).forEach(n=>{e.observe(n,{childList:!0})})};return e=new MutationObserver(t),t(),()=>e.disconnect()}function _(e){return e.toDataURL("image/jpeg").replace(/data:image\/[a-z]+;base64,/g,"")}function U(e){try{e.getContext("2d").getImageData(0,0,1,1)}catch{return!0}return!1}async function y(e,t){!t&&!e.complete&&await new Promise(i=>e.addEventListener("load",i));let n=document.createElement("canvas");return n.width=e.naturalWidth||t?.clientWidth,n.height=e.naturalHeight||t?.clientHeight,n.getContext("2d").drawImage(e,0,0),!U(n)&&n}async function b(e){let n=getComputedStyle(e).backgroundImage;if(!n||n==="none")if("src"in e&&e.src)n=`url("${e.src}")`;else return;if("computedStyleMap"in e){let l=e.computedStyleMap().get("background-image");if(l instanceof CSSImageValue){let m=await y(l,e);if(m)return m}}let o=/"(.+)"/.exec(n);if(!o)return;n=o[1];let i=document.createElement("a");if(i.href=n,new URL(i.href).origin===document.location.origin){let l=new Image;l.crossOrigin="anonymous",l.src=n;let m=await y(l);if(m)return m}let a=await r("fetch::asData",[n,{}]),u=new Image;u.crossOrigin="anonymous",u.src=a.data;let g=await y(u);return g}async function q(e,t){let n={v:d.runtime.getManifest().version,key:G(e)},o=await r("tab::getURL",[]);return o&&(t||!e.key||new URL(o).hostname.endsWith("nopecha.com"))&&(n.url=o),n}function G(e){return!e.keys||!e.keys.length?e.key:e.keys[Math.floor(Math.random()*e.keys.length)]}function P(){let e=new MutationObserver(t=>{let n=R();for(let o of t)if(o.type==="childList"&&o.removedNodes.length&&["app","game"].includes(o.target.id))return T();n===1&&t.length===24&&!document.querySelector(".loading-spinner")&&T(),n===2&&[8,13].includes(t.length)&&!document.querySelector(".loading-spinner")&&T()});return e.observe(document,{childList:!0,subtree:!0,attributes:!0}),()=>e.disconnect()}var F={[0]:{async getTask(){let e=document.querySelector("#game_children_text h2"),t=document.querySelector("#game_challengeItem_image"),n=[...document.querySelectorAll("#game_children_challenge a")];if(!(!e||!t||n.length!==6))return{payload:{type:"funcaptcha",task:e.textContent,image_data:[t.src.replace(/data:image\/[a-z]+;base64,/g,"")]},cells:n}},async solution(e,t){e.cells.forEach((n,o)=>{t.data[o]&&n.click()})}},[1]:{async getTask(){let e=document.querySelector(".tile-game h2"),t=[...document.querySelectorAll(".challenge-container button")];if(!e||t.length!==6)return;let n=await b(t[0]);if(n)return{payload:{type:"funcaptcha",task:e.textContent,image_data:[_(n)]},cells:t}},async solution(e,t){e.cells.forEach((n,o)=>{t.data[o]&&n.click()})}},[2]:{async getTask(){let e=document.querySelector(".match-game h2"),t=document.querySelector(".key-frame-image");if(!e||!t)return;let n=await b(t);if(n)return{payload:{type:"funcaptcha_match",task:e.textContent,image_data:[_(n)]}}},async solution(e,t){let n=document.querySelector(".right-arrow"),o=t.data.indexOf(!0);for(let a=0;a<o;a++)n.click(),await s(100);await s(500),document.querySelector(".button").click()}}},V=[["script[src*=tile-game-ui]",0],[".tile-game",1],[".match-game",2]];function R(){return V.filter(([e])=>document.querySelector(e)).map(([e,t])=>t)[0]}async function T(){await s(100);let e=R();if(e===void 0){console.warn("New FunCaptcha type detected, aborting."),console.warn("Make sure you are running the latest version."),console.warn("If you are, please contact us to get it added: https://nopecha.com/discord");return}let t=F[e],n=await t.getTask();if(!n)return;let o=p(),i=new Date().valueOf(),a=await r("api::recognition",[{...n.payload,...await q(o,!0)}]);if("error"in a)return console.warn("[@nope/funcaptcha] api error",a);let u=new Date().valueOf();if(o.funcaptcha_solve_delay){let g=o.funcaptcha_solve_delay_time-u+i;g>0&&await s(g)}await t.solution(n,a)}function I(){if("ancestorOrigins"in location){let t=location.ancestorOrigins,n=t[1]??t[0];if(n)return n.split("/")[2]}let e=document.referrer;return e?e.split("/")[2]:location.origin}async function W(){B(),await x(),await r("tab::registerDetectedCaptcha",["funcaptcha"]);let e=I();await L(),f("funcaptcha/auto-open",t=>t.enabled&&t.funcaptcha_auto_open&&!t.disabled_hosts.includes(e),D),f("funcaptcha/auto-solve",t=>t.enabled&&t.funcaptcha_auto_solve&&!t.disabled_hosts.includes(e),P)}h(W);})();
