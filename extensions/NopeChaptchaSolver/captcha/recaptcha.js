(()=>{function k(){if("ancestorOrigins"in location){let t=location.ancestorOrigins,n=t[1]??t[0];if(n)return n.split("/")[2]}let e=document.referrer;return e?e.split("/")[2]:location.origin}var g=chrome;function C(e){let t=("fff12fa3cdd64ff83a30d7b392be57e978a86eee93b9728ed0366bf231abdaad"+e).split("").map(n=>n.charCodeAt(0));return x(t)}var M=new Uint32Array(256);for(let e=256;e--;){let t=e;for(let n=8;n--;)t=t&1?3988292384^t>>>1:t>>>1;M[e]=t}function x(e){let t=-1;for(let n of e)t=t>>>8^M[t&255^n];return(t^-1)>>>0}async function c(e,t){let n=""+[+new Date,performance.now(),Math.random()],[o,r]=await new Promise(u=>{g.runtime.sendMessage([n,e,...t],u)});if(o===C(n))return r}function E(){let e;return t=>e||(e=t().finally(()=>e=void 0),e)}var z=E(),s;function L(){return z(async()=>(s||(s=await c("settings::get",[])),s))}function B(e){s&&(s={...s,...e},T(s))}function h(){return s}var H=[];function v(e,t,n){let o=[e,t,n];H.push(o),I(o,h())}function I(e,t){let n=e[1](t),o=!!e[3];n!==o&&(n?e[3]=e[2]():(e[3](),e[3]=null))}function T(e){H.forEach(t=>I(t,e))}function A(){g.runtime.connect({name:"stream"}).onMessage.addListener(t=>{t.event==="settingsUpdate"&&B(t.settings)})}function _(e){if(document.readyState!=="loading")setTimeout(e,0);else{let t;t=()=>{removeEventListener("DOMContentLoaded",t),e()},addEventListener("DOMContentLoaded",t)}}function P(e){return e.toDataURL("image/jpeg").replace(/data:image\/[a-z]+;base64,/g,"")}function G(e){try{e.getContext("2d").getImageData(0,0,1,1)}catch{return!0}return!1}async function R(e,t){!t&&!e.complete&&await new Promise(r=>e.addEventListener("load",r));let n=document.createElement("canvas");return n.width=e.naturalWidth||t?.clientWidth,n.height=e.naturalHeight||t?.clientHeight,n.getContext("2d").drawImage(e,0,0),!G(n)&&n}function D(){return[]}function O(e){return new Promise(t=>{e.push(t)})}function q(e){e.forEach(t=>t()),e.splice(0)}function l(e){return new Promise(t=>setTimeout(t,e))}function N(e){postMessage({source:"nopecha",...e})}function f(e){N(e)}async function V(e,t){let n={v:g.runtime.getManifest().version,key:Q(e)},o=await c("tab::getURL",[]);return o&&(t||!e.key||new URL(o).hostname.endsWith("nopecha.com"))&&(n.url=o),n}function Q(e){return!e.keys||!e.keys.length?e.key:e.keys[Math.floor(Math.random()*e.keys.length)]}var U=D();function j(){let e=new MutationObserver(t=>{q(U);for(let n of t)n.target.id==="rc-imageselect-target"&&n.addedNodes.length&&$()});return e.observe(document.body,{childList:!0,subtree:!0}),document.querySelector(".rc-imageselect")&&$(),()=>e.disconnect()}function Z(){return document.querySelector(".rc-doscaptcha-header")}function ee(){let e=document.querySelector("#recaptcha-verify-button");return e&&e.getAttribute("disabled")}var te={[1]:1,[0]:3,[2]:4};async function ne(){for(;;){await l(1e3);let e=document.querySelector(".rc-imageselect-instructions");if(!e)continue;let t=e.innerText.split(`
`),n=t.slice(0,2).join(" ").replace(/\s+/g," ").trim(),o=[...document.querySelectorAll("table tr td")];if(o.length!==9&&o.length!==16)continue;let r=o.map(i=>i.querySelector("img")).filter(i=>i).filter(i=>i.src.trim());if(r.length!==9&&r.length!==16)continue;let u=o.length===16?2:r.some(i=>i.classList.contains("rc-image-tile-11"))?1:0,d=t.length===3&&u!==2;return{task:n,type:u,cells:o,images:r,waitAfterSolve:d}}}async function $(){if(Z()||ee())return;let e=new Set([...Array(9).keys()]);for(;;){let{task:t,type:n,cells:o,images:r,waitAfterSolve:u}=await ne(),d=h(),i=new Date().valueOf(),b=[];n===1?(r=r.filter((a,m)=>e.has(m)),b.push(...o.filter((a,m)=>e.has(m)))):(r=[r[0]],b.push(...o));let W=(await Promise.all(r.map(a=>R(a)))).map(P),S=te[n],p=await c("api::recognition",[{type:"recaptcha",task:t,image_data:W,grid:[S,S].join("x"),...await V(d)}]);if("error"in p)return console.warn("[@nope/recaptcha] api error",p);let F=new Date().valueOf();if(d.recaptcha_solve_delay){let a=d.recaptcha_solve_delay_time-F+i;a>0&&await l(a)}let w=n===2?4:3;if(b.forEach((a,m)=>{let Y=a.classList.contains("rc-imageselect-tileselected"),y=o.indexOf(a);p.data[m]!==Y&&f({action:"click",selector:`tr:nth-child(${Math.floor(y/w)+1}) td:nth-child(${y%w+1})`}),p.data[m]||e.delete(y)}),!u||!p.data.some(a=>a)){await l(200),f({action:"click",selector:"#recaptcha-verify-button"});return}await O(U),await l(200)}}function X(){let e=document.querySelector(".recaptcha-checkbox"),t=new MutationObserver(r=>{r.length===2&&J()});t.observe(e,{attributes:!0});let n=!1,o=new IntersectionObserver(()=>{n||(n=!0,J())},{threshold:0});return o.observe(document.body),()=>{t.disconnect(),o.disconnect()}}async function J(){await l(400),f({action:"click",selector:".recaptcha-checkbox"})}async function oe(){A(),await L(),await c("tab::registerDetectedCaptcha",["recaptcha"]);let e=k();location.pathname.endsWith("/anchor")?v("recaptcha/auto-open",t=>t.enabled&&t.recaptcha_auto_open&&!t.disabled_hosts.includes(e),X):v("recaptcha/auto-solve",t=>t.enabled&&t.recaptcha_auto_solve&&!t.disabled_hosts.includes(e),j)}_(oe);})();
