(()=>{var a=chrome;function h(e){let t=("fff12fa3cdd64ff83a30d7b392be57e978a86eee93b9728ed0366bf231abdaad"+e).split("").map(o=>o.charCodeAt(0));return y(t)}var b=new Uint32Array(256);for(let e=256;e--;){let t=e;for(let o=8;o--;)t=t&1?3988292384^t>>>1:t>>>1;b[e]=t}function y(e){let t=-1;for(let o of e)t=t>>>8^b[t&255^o];return(t^-1)>>>0}async function i(e,t){let o=""+[+new Date,performance.now(),Math.random()],[n,s]=await new Promise(l=>{a.runtime.sendMessage([o,e,...t],l)});if(n===h(o))return s}function _(){let e;return t=>e||(e=t().finally(()=>e=void 0),e)}var E=_(),r;function w(){return E(async()=>(r||(r=await i("settings::get",[])),r))}function S(e){r&&(r={...r,...e},M(r))}function d(){return r}var v=[];function m(e,t,o){let n=[e,t,o];v.push(n),C(n,d())}function C(e,t){let o=e[1](t),n=!!e[3];o!==n&&(o?e[3]=e[2]():(e[3](),e[3]=null))}function M(e){v.forEach(t=>C(t,e))}function f(e){if(document.readyState!=="loading")setTimeout(e,0);else{let t;t=()=>{removeEventListener("DOMContentLoaded",t),e()},addEventListener("DOMContentLoaded",t)}}function A(){return document.querySelector("#amzn-captcha-verify-button")?.click(),()=>{}}function g(e){return new Promise(t=>setTimeout(t,e))}async function B(e,t){let o={v:a.runtime.getManifest().version,key:L(e)},n=await i("tab::getURL",[]);return n&&(t||!e.key||new URL(n).hostname.endsWith("nopecha.com"))&&(o.url=n),o}function L(e){return!e.keys||!e.keys.length?e.key:e.keys[Math.floor(Math.random()*e.keys.length)]}function u(e){let t=e.querySelector("#amzn-btn-audio-internal [title*=udio], #amzn-btn-audio [title*=udio]");t?.click(),e.querySelector("audio")&&x(e),(e.querySelector("audio")||t)&&i("tab::registerDetectedCaptcha",["awscaptcha"])}function H(){let e,t=o=>{o.filter(n=>n.type==="childList"&&n.addedNodes.length).map(n=>[...n.addedNodes]).flat().filter(n=>n.nodeName==="AWSWAF-CAPTCHA").map(n=>n.shadowRoot).forEach(n=>{e.observe(n,{subtree:!0,childList:!0}),u(n)}),[3,4,5].includes(o.length)?u(o[0].target.parentElement):o.length===1&&o[0].addedNodes.length&&o[0].addedNodes[0].id==="root"&&u(o[0].addedNodes[0])};return e=new MutationObserver(t),e.observe(document,{subtree:!0,childList:!0}),u(document),document.querySelectorAll("awswaf-captcha").forEach(o=>{let n=o.shadowRoot;e.observe(n,{subtree:!0,childList:!0}),u(n)}),()=>e.disconnect()}async function x(e){let t=e.querySelector("audio").src.replace("data:audio/aac;base64,","");if(!t)return;let o=d(),n=new Date().valueOf(),s=await i("api::recognition",[{type:"awscaptcha",audio_data:[t],...await B(o)}]);if("error"in s)return console.warn("[@nope/aws] api error",s);let l=new Date().valueOf();if(o.awscaptcha_solve_delay){let c=o.awscaptcha_solve_delay_time-l+n;c>0&&await g(c)}let p=s.data[0];p?(e.querySelector("input").value=p,await g(200),e.querySelector("#amzn-btn-verify-internal").click()):e.querySelector("#amzn-btn-refresh-internal").click()}function k(){a.runtime.connect({name:"stream"}).onMessage.addListener(t=>{t.event==="settingsUpdate"&&S(t.settings)})}async function T(){k(),await w();let e=location.hostname;m("awscaptcha/auto-open",t=>t.enabled&&t.awscaptcha_auto_open&&!t.disabled_hosts.includes(e),A),m("awscaptcha/auto-solve",t=>t.enabled&&t.awscaptcha_auto_solve&&!t.disabled_hosts.includes(e),H)}f(T);})();
